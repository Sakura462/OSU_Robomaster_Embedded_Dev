/* second-order kalman filter on stm32 */

#include "arm_math.h"
#include "filter.h"
#include "CAN_Receive.h"





#define mat         arm_matrix_instance_f32 
#define mat_init    arm_mat_init_f32
#define mat_add     arm_mat_add_f32
#define mat_sub     arm_mat_sub_f32
#define mat_mult    arm_mat_mult_f32
#define mat_trans   arm_mat_trans_f32
#define mat_inv     arm_mat_inverse_f32

typedef struct
{
  float raw_value;
  float filtered_value[2];
  mat xhat, xhatminus, z, A, H, AT, HT, Q, R, P, Pminus, K;
} kalman_filter_t;

typedef struct
{
  float raw_value;
  float filtered_value[2];
  float xhat_data[2], xhatminus_data[2], z_data[2],Pminus_data[4], K_data[4];
  float P_data[4];
  float AT_data[4], HT_data[4];
  float A_data[4];
  float H_data[4];
  float Q_data[4];
  float R_data[4];
} kalman_filter_init_t;

void kalman_filter_init(kalman_filter_t *F, kalman_filter_init_t *I)
{
  mat_init(&F->xhat,2,1,(float *)I->xhat_data);

  mat_init(&F->HT,2,2,(float *)I->HT_data);
  mat_trans(&F->H, &F->HT);
}

float *kalman_filter_calc(kalman_filter_t *F, float signal1, float signal2)
{
  float TEMP_data[4] = {0, 0, 0, 0};
  float TEMP_data21[2] = {0, 0};
  mat TEMP,TEMP21;

  mat_init(&TEMP,2,2,(float *)TEMP_data);
  mat_init(&TEMP21,2,1,(float *)TEMP_data21);

  F->z.pData[0] = signal1;
  F->z.pData[1] = signal2;

  //1. xhat'(k)= A xhat(k-1)
  mat_mult(&F->A, &F->xhat, &F->xhatminus);

  //2. P'(k) = A P(k-1) AT + Q
  mat_mult(&F->A, &F->P, &F->Pminus);
  mat_mult(&F->Pminus, &F->AT, &TEMP);
  mat_add(&TEMP, &F->Q, &F->Pminus);

  //3. K(k) = P'(k) HT / (H P'(k) HT + R)
  mat_mult(&F->H, &F->Pminus, &F->K);
  mat_mult(&F->K, &F->HT, &TEMP);
  mat_add(&TEMP, &F->R, &F->K);

  mat_inv(&F->K, &F->P);
  mat_mult(&F->Pminus, &F->HT, &TEMP);
  mat_mult(&TEMP, &F->P, &F->K);

  //4. xhat(k) = xhat'(k) + K(k) (z(k) - H xhat'(k))
  mat_mult(&F->H, &F->xhatminus, &TEMP21);
  mat_sub(&F->z, &TEMP21, &F->xhat);
  mat_mult(&F->K, &F->xhat, &TEMP21);
  mat_add(&F->xhatminus, &TEMP21, &F->xhat);

  //5. P(k) = (1-K(k)H)P'(k)
  mat_mult(&F->K, &F->H, &F->P);
  mat_sub(&F->Q, &F->P, &TEMP);
  mat_mult(&TEMP, &F->Pminus, &F->P);

  F->filtered_value[0] = F->xhat.pData[0];
  F->filtered_value[1] = F->xhat.pData[1];

  return F->filtered_value;
}


/* Chebyshev Type II LPF IIR Filter */

#define N 10
const real64_T NUM[N] = {
  4.728303125142e-05,-0.0003212344796949,0.0008974755504678,-0.001237838604899,
  0.0006143145830995,0.0006143145830995,-0.001237838604899,0.0008974755504678,
  -0.0003212344796949,4.728303125142e-05
};

const real64_T DEN[N] = {
                   1,   -8.535326876791,    32.39009699572,   -71.72534454754,
      102.1400805577,   -97.00060811724,    61.43343646769,   -25.02018206012,
      5.946087737604,  -0.6282401568797
};

double Chebyshev_Type_II_IIR_LPF(IIR_Filter_t *F)
{
	int i;
	for(i=N-1; i>0; i--)
	{
		F->ybuf[i] = F->ybuf[i-1]; 
		F->xbuf[i] = F->xbuf[i-1];
	}

	F->xbuf[0] = F->raw_value;
	F->ybuf[0] = NUM[0] * F->xbuf[0];
	for(i=1;i<N;i++)
	{
		F->ybuf[0] = F->ybuf[0] + NUM[i] * F->xbuf[i] - DEN[i] * F->ybuf[i];
	}
	F->filtered_value = F->ybuf[0];
	return F->filtered_value;
}

#define BL 361
const real64_T B[BL] = {
 -4.37654294963e-07, 4.67440449216e-07,-5.156886305406e-07, 5.84850756399e-07,
  -6.774555921344e-07,7.961197389963e-07,-9.435566446229e-07,1.122583365631e-06,
  -1.336124826615e-06,1.587215336933e-06,-1.878997146105e-06,2.214715840514e-06,
  -2.597712408228e-06,3.031411825223e-06,-3.519308044929e-06, 4.06494530379e-06,
  -4.671895688342e-06,5.343732944042e-06,-6.084002542612e-06,6.896188062799e-06,
  -7.783673979129e-06,8.749704994153e-06,-9.797342091698e-06,1.092941553154e-05,
  -1.21484750494e-05,1.345673757007e-05,-1.485603278525e-05,1.634774699169e-05,
  -1.793276562782e-05,1.961141498995e-05,-2.138340364953e-05,2.324776413256e-05,
  -2.520279545972e-05,2.724600718056e-05,-2.937406556724e-05,3.158274266258e-05,
  -3.386686890238e-05,3.622029005331e-05, -3.8635829225e-05,4.110525472682e-05,
  -4.361925454741e-05,4.616741823613e-05,-4.873822696175e-05,5.131905251319e-05,
  -5.389616599019e-05,5.645475690847e-05,-5.897896341346e-05, 6.14519142591e-05,
  -6.385578316396e-05,6.617185610451e-05,-6.83806120465e-05,7.046181754892e-05,
  -7.239463560133e-05,7.415774897464e-05,-7.572949827812e-05,7.708803482132e-05,
  -7.821148827956e-05,7.907814905533e-05,-7.966666511718e-05,7.995625298121e-05,
  -7.992692238028e-05,7.955971404225e-05,-7.883694987207e-05,7.774249470402e-05,
  -7.626202866072e-05,7.438332902565e-05,-7.209656040636e-05, 6.93945718382e-05,
  -6.627319935294e-05,6.273157241544e-05,-5.877242251471e-05,5.440239208468e-05,
  -4.963234182556e-05,4.447765440096e-05,-3.895853239775e-05,3.310028835881e-05,
  -2.693362463199e-05,2.049490072409e-05,-1.382638580709e-05,6.976493995483e-06,
  2.847876024873e-18,-7.041767234736e-06,1.408075528481e-05,-2.104204573519e-05,
   2.78437406924e-05,-3.43968805454e-05, 4.06053951119e-05,-4.636609020589e-05,
  5.156867154061e-05,-5.609580774416e-05,5.982323410995e-05,-6.261989853201e-05,
  6.434815088787e-05,-6.486397692753e-05,6.401727750928e-05,-6.16521937901e-05,
  5.760747873394e-05,-5.171691504368e-05,4.380977935571e-05,-3.371135225963e-05,
  2.124347342159e-05,-6.225140800497e-06,-1.15268473479e-05,3.219720928022e-05,
  -5.597145728591e-05,8.303513811256e-05,-0.0001135730387817,0.0001477683605676,
  -0.0001858018641918,0.0002278509895546,-0.0002740889535866,0.0003246838300453,
  -0.0003797976153152, 0.000439585284481,-0.000504193842139,0.0005737613725822,
  -0.0006484160941503,0.0007282754226567,-0.000813445048911,0.0009040180354268,
  -0.001000073937453, 0.001101677953482,-0.001208880110386, 0.001321714488267,
  -0.001440198490069, 0.001564332160855,-0.001694097561563, 0.001829458201831,
   -0.00197035853635, 0.002116723528916,-0.002268458288142, 0.002425447778471,
  -0.002587556609852, 0.002754628909065,-0.002926488275355,  0.00310293782263,
  -0.003283760310074, 0.003468718362598,-0.003657554782137, 0.003849992950302,
  -0.004045737322474, 0.004244474012927,-0.004445871470084, 0.004649581240547,
  -0.004855238820041,  0.00506246458892,-0.005270864829438, 0.005480032821494,
  -0.005689550013097,  0.00589898726139,-0.006107906139605, 0.006315860304936,
   -0.00652239692194, 0.006727058135683, -0.00692938258858, 0.007128906974485,
  -0.007325167623426, 0.007517702110032,  -0.0077060508786, 0.007889758877508,
  -0.008068377195605, 0.008241464693091,-0.008408589619386, 0.008569331210447,
  -0.008723281258057, 0.008870045643681, -0.00900924582959, 0.009140520300131,
  -0.009263525946214, 0.009377939386324,-0.009483458217655, 0.009579802191247,
  -0.009666714305403, 0.009743961811998,-0.009811337130735, 0.009868658666827,
  -0.009915771528064, 0.009952548137707,-0.009978888740159, 0.009994721796905,
     0.9900004228039, 0.009994721796905,-0.009978888740159, 0.009952548137707,
  -0.009915771528064, 0.009868658666827,-0.009811337130735, 0.009743961811998,
  -0.009666714305403, 0.009579802191247,-0.009483458217655, 0.009377939386324,
  -0.009263525946214, 0.009140520300131, -0.00900924582959, 0.008870045643681,
  -0.008723281258057, 0.008569331210447,-0.008408589619386, 0.008241464693091,
  -0.008068377195605, 0.007889758877508,  -0.0077060508786, 0.007517702110032,
  -0.007325167623426, 0.007128906974485, -0.00692938258858, 0.006727058135683,
   -0.00652239692194, 0.006315860304936,-0.006107906139605,  0.00589898726139,
  -0.005689550013097, 0.005480032821494,-0.005270864829438,  0.00506246458892,
  -0.004855238820041, 0.004649581240547,-0.004445871470084, 0.004244474012927,
  -0.004045737322474, 0.003849992950302,-0.003657554782137, 0.003468718362598,
  -0.003283760310074,  0.00310293782263,-0.002926488275355, 0.002754628909065,
  -0.002587556609852, 0.002425447778471,-0.002268458288142, 0.002116723528916,
   -0.00197035853635, 0.001829458201831,-0.001694097561563, 0.001564332160855,
  -0.001440198490069, 0.001321714488267,-0.001208880110386, 0.001101677953482,
  -0.001000073937453,0.0009040180354268,-0.000813445048911,0.0007282754226567,
  -0.0006484160941503,0.0005737613725822,-0.000504193842139, 0.000439585284481,
  -0.0003797976153152,0.0003246838300453,-0.0002740889535866,0.0002278509895546,
  -0.0001858018641918,0.0001477683605676,-0.0001135730387817,8.303513811256e-05,
  -5.597145728591e-05,3.219720928022e-05,-1.15268473479e-05,-6.225140800497e-06,
  2.124347342159e-05,-3.371135225963e-05,4.380977935571e-05,-5.171691504368e-05,
  5.760747873394e-05,-6.16521937901e-05,6.401727750928e-05,-6.486397692753e-05,
  6.434815088787e-05,-6.261989853201e-05,5.982323410995e-05,-5.609580774416e-05,
  5.156867154061e-05,-4.636609020589e-05, 4.06053951119e-05,-3.43968805454e-05,
   2.78437406924e-05,-2.104204573519e-05,1.408075528481e-05,-7.041767234736e-06,
  2.847876024873e-18,6.976493995483e-06,-1.382638580709e-05,2.049490072409e-05,
  -2.693362463199e-05,3.310028835881e-05,-3.895853239775e-05,4.447765440096e-05,
  -4.963234182556e-05,5.440239208468e-05,-5.877242251471e-05,6.273157241544e-05,
  -6.627319935294e-05, 6.93945718382e-05,-7.209656040636e-05,7.438332902565e-05,
  -7.626202866072e-05,7.774249470402e-05,-7.883694987207e-05,7.955971404225e-05,
  -7.992692238028e-05,7.995625298121e-05,-7.966666511718e-05,7.907814905533e-05,
  -7.821148827956e-05,7.708803482132e-05,-7.572949827812e-05,7.415774897464e-05,
  -7.239463560133e-05,7.046181754892e-05,-6.83806120465e-05,6.617185610451e-05,
  -6.385578316396e-05, 6.14519142591e-05,-5.897896341346e-05,5.645475690847e-05,
  -5.389616599019e-05,5.131905251319e-05,-4.873822696175e-05,4.616741823613e-05,
  -4.361925454741e-05,4.110525472682e-05, -3.8635829225e-05,3.622029005331e-05,
  -3.386686890238e-05,3.158274266258e-05,-2.937406556724e-05,2.724600718056e-05,
  -2.520279545972e-05,2.324776413256e-05,-2.138340364953e-05,1.961141498995e-05,
  -1.793276562782e-05,1.634774699169e-05,-1.485603278525e-05,1.345673757007e-05,
  -1.21484750494e-05,1.092941553154e-05,-9.797342091698e-06,8.749704994153e-06,
  -7.783673979129e-06,6.896188062799e-06,-6.084002542612e-06,5.343732944042e-06,
  -4.671895688342e-06, 4.06494530379e-06,-3.519308044929e-06,3.031411825223e-06,
  -2.597712408228e-06,2.214715840514e-06,-1.878997146105e-06,1.587215336933e-06,
  -1.336124826615e-06,1.122583365631e-06,-9.435566446229e-07,7.961197389963e-07,
  -6.774555921344e-07, 5.84850756399e-07,-5.156886305406e-07, 4.67440449216e-07,
  -4.37654294963e-07
};
double Group_Delay_Filter(FIR_Filter_t *F)
{
	int i;
	for(i=BL-1; i>0; i--)
	{

		F->fir_xbuf[i] = F->fir_xbuf[i-1];
	}

	F->fir_xbuf[0] = F->fir_raw_value;
	F->fir_ybuf[0] = B[0] * F->fir_xbuf[0];
	for(i=1;i<BL;i++)
	{
		F->fir_ybuf[0] = F->fir_ybuf[0] + B[i] * F->fir_xbuf[i];
	}
	F->fir_filtered_value = F->fir_ybuf[0];
	return F->fir_filtered_value;
}

#define BML 31
const real64_T BM[BML] = {
                  -0,-9.62211188284e-05,-0.0003683788513047,-0.0006957735295452,
  -0.000764811040653,5.623668075804e-19, 0.002435030801024, 0.007513091520099,
    0.01608551595623,  0.02854364453621,  0.04450778901153,  0.06267131619306,
    0.08089601338775,  0.09657810270794,   0.1072084332098,   0.1109724944335,
     0.1072084332098,  0.09657810270794,  0.08089601338775,  0.06267131619306,
    0.04450778901153,  0.02854364453621,  0.01608551595623, 0.007513091520099,
   0.002435030801024,5.623668075804e-19,-0.000764811040653,-0.0006957735295452,
  -0.0003683788513047,-9.62211188284e-05,                -0
};

double Blackman_Filter(Blackman_Filter_t *F)
{
	int i;
	for(i=BML-1; i>0; i--)
	{

		F->blm_xbuf[i] = F->blm_xbuf[i-1];
	}

	F->blm_xbuf[0] = F->blm_raw_value;
	F->blm_ybuf[0] = BM[0] * F->blm_xbuf[0];
	for(i=1;i<BML;i++)
	{
		F->blm_ybuf[0] = F->blm_ybuf[0] + BM[i] * F->blm_xbuf[i];
	}
	F->blm_filtered_value = F->blm_ybuf[0];
	return F->blm_filtered_value;
}
